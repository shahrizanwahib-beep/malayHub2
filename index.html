<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malay Class Hub - Modern UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .header-gradient {
            background: #111827; /* Fallback */
            background: linear-gradient(145deg, #1f2937 0%, #111827 100%);
        }
        #welcomeScreen {
            background-image: url('https://i.postimg.cc/tZKZkYvh/Screenshot-2025-10-06-at-1-05-43-PM.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .welcome-overlay {
             background-color: rgba(17, 24, 39, 0.6);
             backdrop-filter: blur(8px);
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* 12px */
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px 0 rgb(0 0 0 / 0.08);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #374151; }
        .btn-outline { background-color: transparent; border-color: #d1d5db; color: #374151; }
        .btn-outline:hover { background-color: #f9fafb; border-color: #9ca3af; }

        .input-field {
             width: 100%;
             padding: 0.75rem 1rem;
             border: 1px solid #d1d5db;
             border-radius: 0.5rem;
        }
        .input-field:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Stail untuk bar kemajuan muat naik */
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            height: 10px;
            background-color: #3b82f6;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">
    <!-- Skrin Selamat Datang -->
    <div id="welcomeScreen" class="min-h-screen">
        <div class="min-h-screen w-full flex items-center justify-center p-4 welcome-overlay">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4 fade-in">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-slate-900 mb-2">Malay Class Hub</h1>
                    <p class="text-slate-600">Crescendo International College</p>
                </div>
                
                <div id="roleSelection" class="space-y-4">
                    <button id="selectStudentRoleBtn" class="btn btn-primary w-full"><i data-lucide="graduation-cap"></i><span>Student Access / Akses Pelajar</span></button>
                    <button id="selectTeacherRoleBtn" class="btn btn-danger w-full"><i data-lucide="user-check"></i><span>Teacher Access / Akses Cikgu</span></button>
                </div>
                
                <div id="studentForm" class="hidden">
                    <form id="nameForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Class Code / Kod Kelas</label>
                            <input type="text" id="classCode" class="input-field" placeholder="Enter class code" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Your Name / Nama Anda</label>
                            <input type="text" id="studentName" class="input-field" placeholder="Enter your full name" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Enter My Hub</button>
                        <button type="button" id="backToRoleStudentBtn" class="btn btn-outline w-full mt-2">Back / Kembali</button>
                    </form>
                </div>
                
                <div id="teacherForm" class="hidden">
                    <form id="teacherLoginForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Email Cikgu</label>
                            <input type="email" id="teacherEmail" class="input-field" placeholder="Enter your email" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                            <input type="password" id="teacherCode" class="input-field" placeholder="Enter password" required>
                        </div>
                        <button type="submit" class="btn btn-danger w-full">Access Dashboard</button>
                        <button type="button" id="backToRoleTeacherBtn" class="btn btn-outline w-full mt-2">Back / Kembali</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherDashboard" class="hidden">
        <header class="header-gradient text-white p-4 shadow-lg sticky top-0 z-40">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center">
                        <i data-lucide="layout-dashboard"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Teacher Dashboard</h1>
                        <p class="text-sm text-slate-400" id="currentTime"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="showClassCode()" class="btn bg-white/10 hover:bg-white/20 text-white !py-2 !px-3">
                        <i data-lucide="key-round"></i><span>Class Code</span>
                    </button>
                    <button onclick="logout()" class="btn bg-red-500/20 hover:bg-red-500/40 text-red-100 !py-2 !px-3">
                        <i data-lucide="log-out"></i><span>Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-4 md:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <!-- Stat Cards -->
                <div class="card p-4 flex items-center justify-between"><div class="space-y-1"><p class="text-slate-500 text-sm font-medium">Active Students</p><p class="text-2xl font-bold text-emerald-500" id="activeStudents">0</p></div><div class="text-emerald-500 bg-emerald-100 p-3 rounded-full"><i data-lucide="users"></i></div></div>
                <div class="card p-4 flex items-center justify-between"><div class="space-y-1"><p class="text-slate-500 text-sm font-medium">Codes Today</p><p class="text-2xl font-bold text-sky-500" id="todayCodes">0</p></div><div class="text-sky-500 bg-sky-100 p-3 rounded-full"><i data-lucide="hash"></i></div></div>
                <div class="card p-4 flex items-center justify-between"><div class="space-y-1"><p class="text-slate-500 text-sm font-medium">Pending</p><p class="text-2xl font-bold text-amber-500" id="pendingSubmissions">0</p></div><div class="text-amber-500 bg-amber-100 p-3 rounded-full"><i data-lucide="hourglass"></i></div></div>
                <div class="card p-4 flex items-center justify-between"><div class="space-y-1"><p class="text-slate-500 text-sm font-medium">Completion</p><p class="text-2xl font-bold text-violet-500" id="completionRate">0%</p></div><div class="text-violet-500 bg-violet-100 p-3 rounded-full"><i data-lucide="trending-up"></i></div></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="card p-6">
                        <h2 class="text-lg font-semibold text-slate-800 flex items-center mb-4"><i data-lucide="clipboard-list" class="mr-2 text-slate-500"></i>Student Overview</h2>
                        <div id="studentOverview" class="space-y-3"><p class="text-slate-500 text-center py-8">No student data available yet.</p></div>
                    </div>
                     <div class="card p-6">
                        <h2 class="text-lg font-semibold text-slate-800 flex items-center mb-4"><i data-lucide="presentation" class="mr-2 text-slate-500"></i>Slide Management</h2>
                        <div class="space-y-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <h3 id="slideFormTitle" class="font-semibold text-slate-700">Add New Slide</h3>
                            <input type="text" id="slideTitle" class="input-field" placeholder="Slide Title, e.g., Bab 1 - Karangan">
                            <textarea id="slideContent" class="input-field font-mono text-sm" rows="3" placeholder="Paste URL or <iframe> embed code here."></textarea>
                            <div class="flex space-x-2">
                                <button onclick="saveSlide()" id="saveSlideBtn" class="btn btn-primary bg-emerald-600 hover:bg-emerald-700 flex-1">Save Slide</button>
                                <button onclick="cancelEditSlide()" id="cancelEditBtn" class="hidden btn btn-secondary flex-1">Cancel Edit</button>
                            </div>
                        </div>
                        <div id="slidesListContainer" class="mt-4 space-y-2"><p class="text-slate-500 text-center py-4">No slides saved yet.</p></div>
                    </div>
                </div>
                <div class="lg:col-span-1 space-y-6">
                    <div class="card p-6">
                        <h2 class="text-lg font-semibold text-slate-800 flex items-center mb-4"><i data-lucide="wifi" class="mr-2 text-emerald-500"></i>Live Student Status</h2>
                        <div id="liveStudentStatus" class="space-y-2"><p class="text-slate-500 text-center py-4">No students online.</p></div>
                    </div>
                    <div class="card p-6">
                        <h2 class="text-lg font-semibold text-slate-800 flex items-center mb-4"><i data-lucide="activity" class="mr-2 text-red-500"></i>Live Activity Feed</h2>
                        <div id="activityFeed" class="max-h-96 overflow-y-auto space-y-3 pr-2"><p class="text-slate-500 text-center py-8">Waiting for activities.</p></div>
                    </div>
                </div>
            </div>
             <div class="mt-6 card p-6">
                <h2 class="text-lg font-semibold text-slate-800 mb-4 flex items-center"><i data-lucide="archive" class="mr-2 text-slate-500"></i>All Submission Codes</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50"><tr><th class="px-4 py-3">Code</th><th class="px-4 py-3">Student</th><th class="px-4 py-3">Skill</th><th class="px-4 py-3">File</th><th class="px-4 py-3">Generated</th><th class="px-4 py-3">Status</th><th class="px-4 py-3">Action</th></tr></thead>
                        <tbody id="codesTable" class="divide-y divide-slate-200"><tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">No codes generated yet.</td></tr></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Student Hub -->
    <div id="mainHub" class="hidden">
        <header class="header-gradient text-white p-4 shadow-lg sticky top-0 z-40">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center"><i data-lucide="book-open"></i></div>
                    <div>
                        <h1 class="text-xl font-bold">Selamat datang, <span id="displayName"></span>!</h1>
                        <p class="text-sm text-slate-400" id="currentDate"></p>
                    </div>
                </div>
                 <button onclick="logout()" class="btn bg-red-500/20 hover:bg-red-500/40 text-red-100 !py-2 !px-3">
                    <i data-lucide="log-out"></i><span>Logout</span>
                </button>
            </div>
        </header>

        <main class="max-w-6xl mx-auto p-4 md:p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="card p-6">
                        <h2 class="text-lg font-semibold text-slate-800 mb-4">Aktiviti Tugasan</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Skill cards -->
                             <div class="p-4 bg-sky-50 border-l-4 border-sky-500 rounded-r-lg"><h3 class="font-semibold text-sky-800 mb-2">‚úçÔ∏è Menulis (Writing)</h3><p class="text-sm text-slate-600 mb-3">Karangan Deskriptif</p><button onclick="openUploadModal('MENULIS', 'Karangan Deskriptif')" class="btn bg-sky-500 hover:bg-sky-600 text-white w-full !py-2">Hantar Tugasan</button></div>
                             <div class="p-4 bg-emerald-50 border-l-4 border-emerald-500 rounded-r-lg"><h3 class="font-semibold text-emerald-800 mb-2">üìñ Membaca (Reading)</h3><p class="text-sm text-slate-600 mb-3">Analisis Cerpen</p><button onclick="openUploadModal('MEMBACA', 'Analisis Cerpen')" class="btn bg-emerald-500 hover:bg-emerald-600 text-white w-full !py-2">Hantar Tugasan</button></div>
                             <div class="p-4 bg-amber-50 border-l-4 border-amber-500 rounded-r-lg"><h3 class="font-semibold text-amber-800 mb-2">üé§ Bertutur (Speaking)</h3><p class="text-sm text-slate-600 mb-3">Syarahan 3 Minit</p><button onclick="openUploadModal('BERTUTUR', 'Syarahan 3 Minit')" class="btn bg-amber-500 hover:bg-amber-600 text-white w-full !py-2">Hantar Tugasan</button></div>
                             <div class="p-4 bg-violet-50 border-l-4 border-violet-500 rounded-r-lg"><h3 class="font-semibold text-violet-800 mb-2">üëÇ Mendengar (Listening)</h3><p class="text-sm text-slate-600 mb-3">Respons Audio</p><button onclick="openUploadModal('MENDENGAR', 'Respons Audio')" class="btn bg-violet-500 hover:bg-violet-600 text-white w-full !py-2">Hantar Tugasan</button></div>
                        </div>
                    </div>
                     <div class="card p-6">
                        <h2 class="text-lg font-semibold text-slate-800 mb-4">Sejarah Kod Penyerahan</h2>
                        <div id="submissionHistory" class="space-y-2"><p class="text-slate-500 text-center py-8">Tiada kod dijana lagi.</p></div>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-6">
                    <div class="card p-6">
                         <h2 class="text-lg font-semibold text-slate-800 mb-4">Slaid Kelas</h2>
                        <div id="studentSlidesList" class="space-y-2 mb-4"><p class="text-slate-500 text-center p-4">Tiada slaid tersedia.</p></div>
                        <div id="studentSlideDisplay" class="slide-display-container bg-slate-100 rounded-lg flex items-center justify-center">
                           <p class="text-slate-500 text-sm p-4 text-center">Pilih tajuk slaid di atas.</p>
                        </div>
                    </div>
                    <div class="card p-6">
                         <h2 class="text-lg font-semibold text-slate-800 mb-4">Latihan Interaktif</h2>
                        <div class="p-4 bg-red-50 rounded-lg">
                            <h3 class="font-semibold text-red-800 mb-2">Permainan Bina Ayat</h3>
                            <button onclick="openGameModal()" class="btn bg-red-500 hover:bg-red-600 text-white w-full">Mula Main!</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="classCodeModal" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 fade-in"><div class="text-center mb-6"><div class="text-4xl mb-4">üîë</div><h2 class="text-2xl font-bold text-slate-800 mb-2">Your Class Code</h2><p class="text-slate-600">Share this code with your students</p></div><div class="mb-6"><div id="displayClassCode" class="text-2xl text-center font-mono p-4 bg-slate-100 border-2 border-dashed border-slate-300 rounded-lg mb-4"></div><div class="flex space-x-2"><button onclick="copyClassCode(event)" class="btn btn-primary flex-1">Copy Code</button><button onclick="generateNewClassCode()" class="btn btn-outline flex-1 bg-emerald-50 border-emerald-200 text-emerald-700 hover:bg-emerald-100">New Code</button></div></div><button onclick="closeClassCodeModal()" class="btn btn-secondary w-full">Close</button></div></div>
    <div id="codeModal" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 fade-in"><div class="text-center mb-6"><div class="text-4xl mb-4">üéØ</div><h2 class="text-2xl font-bold text-slate-800 mb-2">Submission Code Generated!</h2><p class="text-slate-600">Copy and use this code for your assignment</p></div><div class="mb-6"><div id="generatedCode" class="text-2xl text-center font-mono p-4 bg-slate-100 border-2 border-dashed border-slate-300 rounded-lg"></div></div><div class="flex space-x-3"><button onclick="copyCode(event)" class="btn bg-emerald-600 hover:bg-emerald-700 flex-1">Copy Code</button><button onclick="closeModal()" class="btn btn-secondary flex-1">Close</button></div></div></div>
    <div id="uploadModal" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 fade-in"><div class="text-center mb-4"><div class="text-4xl mb-4">üì§</div><h2 id="uploadModalTitle" class="text-2xl font-bold text-slate-800 mb-2">Submit Assignment</h2><p id="uploadModalSubtitle" class="text-slate-600">Please upload your document file.</p></div><div class="space-y-4 my-6"><input type="file" id="fileInput" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/><div id="uploadProgressContainer" class="hidden space-y-2"><div class="progress-bar-container"><div id="uploadProgressBar" class="progress-bar" style="width: 0%"></div></div><p id="uploadProgressText" class="text-sm text-center text-slate-500">Uploading...</p></div></div><div class="flex space-x-3"><button id="uploadBtn" class="btn btn-primary flex-1">Upload & Get Code</button><button onclick="closeUploadModal()" class="btn btn-secondary flex-1">Cancel</button></div></div></div>
    <div id="gameModal" class="hidden fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl p-6 md:p-8 max-w-2xl w-full mx-4 fade-in"><div class="text-center mb-4"><h2 class="text-2xl font-bold text-slate-800 mb-1">Permainan Bina Ayat</h2><p class="text-slate-600">Drag the words to form a correct sentence.</p></div><div class="my-6"><div id="sentenceZone" class="min-h-[6rem] bg-slate-100 rounded-lg p-4 border-2 border-dashed border-slate-300 flex flex-wrap items-center gap-2 mb-4"><span class="text-slate-400">Drag words here...</span></div><div id="wordBank" class="min-h-[6rem] bg-sky-50 rounded-lg p-4 flex flex-wrap justify-center items-center gap-3"></div></div><div id="feedbackMessage" class="text-center font-bold text-lg mb-4 h-6"></div><div class="grid grid-cols-2 md:grid-cols-3 gap-3"><button onclick="checkSentence()" id="checkAnswerBtn" class="btn bg-emerald-500 hover:bg-emerald-600 text-white">Check</button><button onclick="resetCurrentSentence()" id="resetBtn" class="btn bg-amber-500 hover:bg-amber-600 text-white">Reset</button><button onclick="startNewGame()" id="nextSentenceBtn" class="btn btn-primary hidden">Next</button><button onclick="closeGameModal()" class="btn btn-secondary col-span-2 md:col-span-3">Close Game</button></div></div></div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, onSnapshot, query, where, getDocs, updateDoc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyANKzGt2753sNPOQO5FMfON5RBV5WvOlM0",
            authDomain: "malay-class-hub.firebaseapp.com",
            projectId: "malay-class-hub",
            storageBucket: "malay-class-hub.firebasestorage.app",
            messagingSenderId: "917601285789",
            appId: "1:917601285789:web:c6568b4f1615689e804674"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let studentName = '';
        let currentCode = '';
        let teacherClassId = null;
        let studentClassId = null;
        let classCode = '';
        let heartbeatInterval;
        let unsubscribeListeners = [];
        let editingSlideId = null;
        let teacherSlidesData = [];
        let studentSlidesData = [];
        
        const showView = (viewId) => {
            ['welcomeScreen', 'teacherDashboard', 'mainHub'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            const view = document.getElementById(viewId);
            if(view) {
                view.classList.remove('hidden');
                lucide.createIcons();
            }
        };

        onAuthStateChanged(auth, (user) => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            if (user) {
                currentUser = user;
                if (user.isAnonymous) {
                    studentName = localStorage.getItem('currentStudentName');
                    studentClassId = localStorage.getItem('studentClassId');
                    if(studentName && studentClassId) {
                        document.getElementById('displayName').textContent = studentName;
                        showView('mainHub');
                        loadStudentHubData();
                        startHeartbeat();
                        if (sessionStorage.getItem('isNewLogin') === 'true') {
                            logActivity(`${studentName} logged into their hub`, 'login');
                            sessionStorage.removeItem('isNewLogin');
                        }
                    }
                } else {
                    teacherClassId = user.uid;
                    showView('teacherDashboard');
                    setupTeacherDashboardListeners();
                    loadClassCode();
                }
            } else {
                currentUser = null;
                teacherClassId = null; studentClassId = null;
                showView('welcomeScreen');
                backToRoleSelection();
                clearInterval(heartbeatInterval);
            }
        });

        document.getElementById('teacherLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('teacherEmail').value;
            const password = document.getElementById('teacherCode').value;
            try { 
                await signInWithEmailAndPassword(auth, email, password); 
            } catch (error) { 
                console.error(`Login failed: ${error.message}`); 
            }
        });

        document.getElementById('nameForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const enteredClassCode = document.getElementById('classCode').value.trim();
            const tempStudentName = document.getElementById('studentName').value.trim();
            if (!enteredClassCode || !tempStudentName) { 
                console.error("Please fill in Class Code and your Name."); 
                return; 
            }
            try {
                const q = query(collection(db, "classes"), where("classCode", "==", enteredClassCode));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { 
                    console.error('Invalid class code!'); 
                    return; 
                } 
                const classDoc = querySnapshot.docs[0];
                studentClassId = classDoc.id;
                localStorage.setItem('studentClassId', studentClassId);
                localStorage.setItem('currentStudentName', tempStudentName);
                
                sessionStorage.setItem('isNewLogin', 'true');
                if (auth.currentUser) { await signOut(auth); }
                await signInAnonymously(auth);
            } catch (error) { 
                console.error(`Student login process failed: ${error.message}`); 
            }
        });

        window.logout = function() { signOut(auth); }

        async function loadClassCode() {
            if (!teacherClassId) return;
            const classRef = doc(db, "classes", teacherClassId);
            const classSnap = await getDoc(classRef);
            if (classSnap.exists() && classSnap.data().classCode) {
                classCode = classSnap.data().classCode;
            } else { await generateNewClassCode(false); }
        }

        function setupTeacherDashboardListeners() {
            if (!teacherClassId) return;
            const classRef = doc(db, "classes", teacherClassId);
            const submissionsQuery = collection(classRef, "submissions");
            const activitiesQuery = query(collection(classRef, "activities"), orderBy("timestamp", "desc"), where("timestamp", ">", new Date(Date.now() - 24 * 60 * 60 * 1000)));
            const activeStudentsQuery = collection(classRef, "active_students");
            const slidesQuery = query(collection(classRef, "slides"), orderBy("timestamp", "asc"));

            unsubscribeListeners.push(
                onSnapshot(submissionsQuery, (snapshot) => {
                    const allSubmissions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateCodesTable(allSubmissions);
                    updateTeacherStats(allSubmissions);
                    updateStudentOverview(allSubmissions);
                }),
                onSnapshot(activitiesQuery, (snapshot) => updateActivityFeed(snapshot.docs.map(d => d.data()))),
                onSnapshot(activeStudentsQuery, (snapshot) => {
                    const activeStudentsData = snapshot.docs.reduce((acc, d) => { acc[d.id] = d.data(); return acc; }, {});
                    updateLiveStudentStatus(activeStudentsData);
                }),
                onSnapshot(slidesQuery, (snapshot) => {
                    teacherSlidesData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderTeacherSlidesList(teacherSlidesData);
                })
            );
        }

        function loadStudentHubData() {
            if (!studentClassId || !currentUser) return;
            const classRef = doc(db, "classes", studentClassId);
            const submissionsQuery = query(collection(classRef, "submissions"), where("studentUid", "==", currentUser.uid), orderBy("timestamp", "desc"));
            const slidesQuery = query(collection(classRef, "slides"), orderBy("timestamp", "asc"));

            unsubscribeListeners.push(
                onSnapshot(submissionsQuery, (snapshot) => {
                    const studentSubmissions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateSubmissionHistory(studentSubmissions);
                }),
                onSnapshot(slidesQuery, (snapshot) => {
                    studentSlidesData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderStudentSlidesList(studentSlidesData);
                })
            );
        }
        
        // --- Submission and File Upload Logic ---
        window.openUploadModal = (skill, assignment) => {
            const modal = document.getElementById('uploadModal');
            modal.dataset.skill = skill;
            modal.dataset.assignment = assignment;
            
            const subtitle = document.getElementById('uploadModalSubtitle');
            subtitle.textContent = `Sila muat naik fail untuk ${assignment}. (Max 2MB)`;
            subtitle.classList.remove('text-red-500');
            subtitle.classList.add('text-slate-600');

            document.getElementById('uploadModalTitle').textContent = `Hantar Tugasan: ${skill}`;
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadProgressContainer').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = false;
            
            modal.classList.remove('hidden');
        };

        window.closeUploadModal = () => {
            document.getElementById('uploadModal').classList.add('hidden');
        };

        document.getElementById('uploadBtn').addEventListener('click', async () => {
            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('uploadProgressContainer');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            const subtitle = document.getElementById('uploadModalSubtitle');
            let submissionRef;

            try {
                const modal = document.getElementById('uploadModal');
                const { skill, assignment } = modal.dataset;
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];

                if (!file) {
                    subtitle.textContent = "Sila pilih fail untuk dimuat naik.";
                    subtitle.classList.add('text-red-500');
                    return;
                }

                const maxSizeInBytes = 2 * 1024 * 1024; // 2 MB
                if (file.size > maxSizeInBytes) {
                    subtitle.textContent = "Fail terlalu besar. Saiz maksimum ialah 2MB.";
                    subtitle.classList.add('text-red-500');
                    fileInput.value = ''; // Clear the selected file
                    return;
                }

                if (!studentClassId || !currentUser) {
                     console.error("Student not logged in correctly.");
                     subtitle.textContent = "Error: Not logged in correctly. Please refresh.";
                     subtitle.classList.add('text-red-500');
                    return;
                }

                subtitle.textContent = `Sila muat naik fail untuk ${assignment}. (Max 2MB)`;
                subtitle.classList.remove('text-red-500');
                
                uploadBtn.disabled = true;
                progressContainer.classList.remove('hidden');

                const shortName = studentName.split(' ')[0].toUpperCase();
                const skillCode = skill.substring(0, 3);
                const randomNum = Math.floor(Math.random() * 999) + 1;
                currentCode = `BM-${skillCode}-${String(randomNum).padStart(3, '0')}-${shortName}`;
                
                submissionRef = await addDoc(collection(db, "classes", studentClassId, "submissions"), {
                    code: currentCode, skill, assignment, studentName, studentUid: currentUser.uid, 
                    timestamp: serverTimestamp(), status: 'Uploading...', fileName: file.name
                });

                const storageRef = ref(storage, `classes/${studentClassId}/${submissionRef.id}/${file.name}`);
                const uploadTask = uploadBytesResumable(storageRef, file);

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `Uploading... ${Math.round(progress)}%`;
                    }, 
                    (error) => {
                        console.error("Upload failed:", error);
                        if (submissionRef) updateDoc(submissionRef, { status: 'Upload Failed' });
                        subtitle.textContent = `Upload failed: ${error.code}. Please try again.`;
                        subtitle.classList.add('text-red-500');
                        uploadBtn.disabled = false;
                        progressContainer.classList.add('hidden');
                    }, 
                    async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        await updateDoc(submissionRef, { status: 'Menunggu Penyerahan', fileURL: downloadURL });
                        await logActivity(`${studentName} submitted file for ${assignment}`, 'submission');
                        
                        closeUploadModal();
                        document.getElementById('generatedCode').textContent = currentCode;
                        document.getElementById('codeModal').classList.remove('hidden');
                    }
                );
            } catch (error) {
                console.error("An error occurred during submission:", error);
                if (submissionRef) await updateDoc(submissionRef, { status: 'Upload Failed' });
                subtitle.textContent = "An unexpected error occurred. Please try again.";
                subtitle.classList.add('text-red-500');
                uploadBtn.disabled = false;
                progressContainer.classList.add('hidden');
            }
        });

        async function logActivity(message, type) {
            const classId = teacherClassId || studentClassId;
            if (!classId) return;
            const activity = { message, type, timestamp: serverTimestamp(), studentName: studentName || 'System', studentUid: currentUser ? currentUser.uid : 'system' };
            await addDoc(collection(db, "classes", classId, "activities"), activity);
        }
        
        async function startHeartbeat() {
            if (!studentClassId || !currentUser) return;
            const activeStudentRef = doc(db, "classes", studentClassId, "active_students", currentUser.uid);
            const updateStatus = (status) => setDoc(activeStudentRef, { name: studentName, lastSeen: serverTimestamp(), status: status }, { merge: true });
            updateStatus('online');
            heartbeatInterval = setInterval(() => updateStatus('online'), 30000);
            document.addEventListener('visibilitychange', () => updateStatus(document.hidden ? 'away' : 'online'));
        }

        function updateTeacherStats(submissions = []) {
            const todayStart = new Date();
            todayStart.setHours(0,0,0,0);
            const todayCodes = submissions.filter(s => s.timestamp && s.timestamp.toDate() > todayStart).length;
            const pending = submissions.filter(s => s.status === 'Menunggu Penyerahan').length;
            const completed = submissions.filter(s => s.status === 'Selesai').length;
            const rate = submissions.length > 0 ? Math.round((completed / submissions.length) * 100) : 0;
            document.getElementById('todayCodes').textContent = todayCodes;
            document.getElementById('pendingSubmissions').textContent = pending;
            document.getElementById('completionRate').textContent = `${rate}%`;
        }

        function updateLiveStudentStatus(activeStudents = {}) {
            const container = document.getElementById('liveStudentStatus');
            const now = Date.now();
            const onlineStudents = Object.values(activeStudents).filter(s => s.lastSeen && (now - s.lastSeen.toDate().getTime()) < 60000); // Online within last minute
            document.getElementById('activeStudents').textContent = onlineStudents.length;
            if (onlineStudents.length === 0) { container.innerHTML = '<p class="text-slate-500 text-center py-4">No students online.</p>'; return; }
            container.innerHTML = onlineStudents.map(student => `<div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg"><div class="flex items-center space-x-2"><span class="w-2 h-2 bg-emerald-400 rounded-full"></span><p class="text-sm font-medium text-slate-800">${student.name}</p></div><p class="text-xs text-slate-400">${getTimeAgo(student.lastSeen.toDate())}</p></div>`).join('');
        }
        
        function updateActivityFeed(activities = []) {
            const container = document.getElementById('activityFeed');
            if (activities.length === 0) { container.innerHTML = '<p class="text-slate-500 text-center py-8">No recent activities.</p>'; return; }
            container.innerHTML = activities.slice(0, 15).map(act => {
                const iconMap = {'login': 'log-in', 'submission': 'upload-cloud', 'game_completion': 'swords'};
                return `<div class="flex items-start space-x-3 p-2 hover:bg-slate-50 rounded-md"><i data-lucide="${iconMap[act.type] || 'file-pen-line'}" class="w-4 h-4 text-slate-400 mt-1"></i><div class="flex-1"><p class="text-sm text-slate-700">${act.message}</p><p class="text-xs text-slate-400">${getTimeAgo(act.timestamp.toDate())}</p></div></div>`;
            }).join('');
            lucide.createIcons();
        }
        
        function updateCodesTable(submissions = []) {
            const tableBody = document.getElementById('codesTable');
            if (submissions.length === 0) { tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-slate-500">No codes generated yet.</td></tr>'; return; }
            submissions.sort((a,b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            tableBody.innerHTML = submissions.map(s => {
                const fileLink = s.fileURL 
                    ? `<a href="${s.fileURL}" target="_blank" class="flex items-center space-x-1 text-sky-600 hover:underline"><i data-lucide="file-text" class="w-4 h-4"></i><span>View File</span></a>`
                    : '<span>-</span>';

                return `<tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 font-mono text-sm">${s.code || ''}</td>
                    <td class="px-4 py-3">${s.studentName}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${getSkillColor(s.skill, 'bg')}">${s.skill}</span></td>
                    <td class="px-4 py-3">${fileLink}</td>
                    <td class="px-4 py-3 text-sm text-slate-500">${s.timestamp ? new Date(s.timestamp.toDate()).toLocaleString('ms-MY') : ''}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(s.status, 'bg')}">${s.status}</span></td>
                    <td class="px-4 py-3">${s.status === 'Menunggu Penyerahan' ? `<button onclick="markAsReceived('${s.id}')" class="text-emerald-600 hover:text-emerald-800 text-sm font-semibold">Mark Received</button>` : '<span>-</span>'}</td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }

        function updateStudentOverview(submissions = []) {
            const container = document.getElementById('studentOverview');
            const studentStats = {};
            submissions.forEach(s => {
                if (!s.studentUid) return;
                if (!studentStats[s.studentUid]) { studentStats[s.studentUid] = { name: s.studentName, total: 0, skills: {}, lastActivity: s.timestamp }; }
                studentStats[s.studentUid].total++;
                studentStats[s.studentUid].skills[s.skill] = (studentStats[s.studentUid].skills[s.skill] || 0) + 1;
                if (!studentStats[s.studentUid].lastActivity || s.timestamp > studentStats[s.studentUid].lastActivity) {
                    studentStats[s.studentUid].lastActivity = s.timestamp;
                }
            });
            const students = Object.values(studentStats);
            if (students.length === 0) { container.innerHTML = '<p class="text-slate-500 text-center py-8">No student data available.</p>'; return; }
            container.innerHTML = students.map(s => `<div class="border border-slate-200 rounded-lg p-3"><div class="flex items-center justify-between mb-2"><h3 class="font-semibold text-slate-800">${s.name}</h3><span class="text-xs text-slate-400">Last: ${s.lastActivity ? getTimeAgo(s.lastActivity.toDate()) : 'N/A'}</span></div><div class="flex space-x-2">${['MENULIS', 'MEMBACA', 'BERTUTUR', 'MENDENGAR'].map(skill => `<div class="flex-1 text-center p-2 rounded-md ${getSkillColor(skill, 'soft-bg')}"><div class="text-lg font-bold ${getSkillColor(skill, 'text')}">${s.skills[skill] || 0}</div><div class="text-xs ${getSkillColor(skill, 'text-soft')}">${skill.substring(0,3)}</div></div>`).join('')}</div></div>`).join('');
        }
        
        function updateSubmissionHistory(submissions = []) {
            const container = document.getElementById('submissionHistory');
            if (submissions.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-4">Tiada kod dijana lagi.</p>';
                return;
            }
            container.innerHTML = submissions.map(s => {
                const fileInfo = s.fileURL 
                    ? `<a href="${s.fileURL}" target="_blank" class="text-xs text-sky-600 hover:underline flex items-center gap-1 mt-1"><i data-lucide="download-cloud" class="w-3 h-3"></i><span>${s.fileName || 'View File'}</span></a>` 
                    : '';
                return `
                <div class="p-3 bg-slate-50 rounded-lg flex justify-between items-center border">
                    <div class="space-y-1 flex-1 min-w-0">
                        <p class="font-mono text-sm font-medium truncate">${s.code}</p>
                        <p class="text-xs text-slate-500 truncate">${s.assignment} (${s.skill})</p>
                        ${fileInfo}
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-md ${getStatusColor(s.status, 'bg')} ml-2 flex-shrink-0">${s.status}</span>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        // --- Game Logic ---
        const sentences = [ "Saya suka makan nasi lemak.", "Kucing itu sedang tidur di atas sofa.", "Mereka akan pergi ke sekolah esok pagi.", "Bunga mawar itu berwarna merah jambu.", "Adik saya pandai melukis pemandangan." ];
        let currentSentence = "", shuffledWords = [];
        function startNewGame() {
            currentSentence = sentences[Math.floor(Math.random() * sentences.length)];
            const words = currentSentence.replace('.', '').split(' ');
            shuffledWords = [...words].sort(() => Math.random() - 0.5);
            document.getElementById('wordBank').innerHTML = shuffledWords.map((word, i) => `<div id="word-${i}" draggable="true" class="draggable-word bg-white text-slate-800 px-4 py-2 rounded-lg shadow font-semibold">${word}</div>`).join('');
            document.querySelectorAll('.draggable-word').forEach(el => el.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', e.target.id); }));
            resetCurrentSentence();
            ['feedbackMessage', 'checkAnswerBtn', 'resetBtn'].forEach(id => document.getElementById(id).classList.remove('hidden'));
            document.getElementById('nextSentenceBtn').classList.add('hidden');
        }
        function resetCurrentSentence() {
            document.getElementById('sentenceZone').innerHTML = '<span class="text-slate-400">Drag words here...</span>';
            shuffledWords.forEach((_, i) => document.getElementById(`word-${i}`) && document.getElementById('wordBank').appendChild(document.getElementById(`word-${i}`)));
            document.getElementById('feedbackMessage').innerHTML = '';
        }
        function checkSentence() {
            const constructed = Array.from(document.getElementById('sentenceZone').children).filter(el => el.id).map(el => el.textContent).join(' ') + '.';
            const feedback = document.getElementById('feedbackMessage');
            if (constructed === currentSentence) {
                feedback.innerHTML = '<span class="text-emerald-500">üéâ Correct! Well done! üéâ</span>';
                logActivity(`${studentName} completed a 'Bina Ayat' exercise.`, 'game_completion');
                ['checkAnswerBtn', 'resetBtn'].forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById('nextSentenceBtn').classList.remove('hidden');
            } else { feedback.innerHTML = '<span class="text-red-500">üò• Not quite, try again.</span>'; }
        }
        const dropZone = document.getElementById('sentenceZone');
        dropZone.addEventListener('dragover', e => e.preventDefault());
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            const id = e.dataTransfer.getData('text');
            const draggedEl = document.getElementById(id);
            if (dropZone.querySelector('span')) dropZone.innerHTML = '';
            dropZone.appendChild(draggedEl);
        });
        
        // --- Slide Logic ---
        window.saveSlide = async function() {
            if (!teacherClassId) return;
            const title = document.getElementById('slideTitle').value.trim();
            const content = document.getElementById('slideContent').value.trim();
            if (!title || !content) {
                console.error('Please provide a title and content.');
                return;
            }
            try {
                const data = { title, content, timestamp: serverTimestamp() };
                if (editingSlideId) {
                    await updateDoc(doc(db, "classes", teacherClassId, "slides", editingSlideId), { title, content });
                } else {
                    await addDoc(collection(db, "classes", teacherClassId, "slides"), data);
                }
                cancelEditSlide();
            } catch (error) { console.error("Error saving slide:", error); }
        }
        window.editSlide = function(id) {
            const slide = teacherSlidesData.find(s => s.id === id);
            if (!slide) return;
            editingSlideId = id;
            document.getElementById('slideFormTitle').textContent = 'Update Slide';
            document.getElementById('slideTitle').value = slide.title;
            document.getElementById('slideContent').value = slide.content;
            document.getElementById('saveSlideBtn').textContent = 'Update Slide';
            document.getElementById('cancelEditBtn').classList.remove('hidden');
        }
        window.cancelEditSlide = function() {
            editingSlideId = null;
            document.getElementById('slideFormTitle').textContent = 'Add New Slide';
            document.getElementById('slideTitle').value = '';
            document.getElementById('slideContent').value = '';
            document.getElementById('saveSlideBtn').textContent = 'Save Slide';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }
        window.deleteSlide = async function(id) {
            if (!teacherClassId) return;
            try { 
                await deleteDoc(doc(db, "classes", teacherClassId, "slides", id)); 
            } catch (error) { 
                console.error("Error deleting slide:", error); 
            }
        }
        function renderTeacherSlidesList(slides = []) {
            const container = document.getElementById('slidesListContainer');
            if (!slides.length) { container.innerHTML = '<p class="text-slate-500 text-center py-4">No slides saved yet.</p>'; return; }
            container.innerHTML = slides.map((slide, i) => {
                const preview = (slide.content || '').startsWith('<iframe') ? 'iframe embed code' : (slide.content || '');
                return `<div class="flex items-center justify-between p-2.5 bg-slate-100 rounded-lg"><div class="min-w-0"><p class="text-sm font-medium text-slate-800 truncate">${i + 1}. ${slide.title}</p><p class="text-xs text-slate-500 font-mono truncate">${preview}</p></div><div class="flex-shrink-0 space-x-2 ml-2"><button onclick="editSlide('${slide.id}')" class="text-sky-600 hover:underline text-sm font-medium">Edit</button><button onclick="deleteSlide('${slide.id}')" class="text-red-600 hover:underline text-sm font-medium">Delete</button></div></div>`;
            }).join('');
        }
        function renderStudentSlidesList(slides = []) {
            const container = document.getElementById('studentSlidesList');
            if (!slides.length) { container.innerHTML = '<p class="text-slate-500 text-center p-4">No slides available.</p>'; return; }
            container.innerHTML = slides.map((slide, i) => `<div id="slide-item-${slide.id}" onclick="displaySlide('${slide.id}')" class="student-slide-item p-3 border-b border-slate-200 rounded-md hover:bg-slate-100 cursor-pointer"><p class="font-medium text-slate-800">${i + 1}. ${slide.title}</p></div>`).join('');
        }
        window.displaySlide = function(id) {
            const slide = studentSlidesData.find(s => s.id === id);
            if (!slide) return;
            const container = document.getElementById('studentSlideDisplay');
            const content = (slide.content || '').trim();
            container.innerHTML = content.startsWith('<iframe') ? content : `<iframe src="${content}" class="w-full h-full" allowfullscreen></iframe>`;
            document.querySelectorAll('.student-slide-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`slide-item-${id}`).classList.add('active');
        }
        
        // --- Helper Functions ---
        window.markAsReceived = async function(id) {
            if (!teacherClassId) return;
            await updateDoc(doc(db, "classes", teacherClassId, "submissions", id), { status: 'Selesai' });
        }
        window.generateNewClassCode = async function(showConfirm = true) {
            if (!teacherClassId) return;
            const newCode = 'BM-' + Math.random().toString(36).substring(2, 8).toUpperCase();
            await setDoc(doc(db, "classes", teacherClassId), { classCode: newCode }, { merge: true });
            classCode = newCode;
            document.getElementById('displayClassCode').textContent = newCode;
        }
        const selectRole = (role) => {
            document.getElementById('roleSelection').classList.add('hidden');
            document.getElementById(role === 'student' ? 'studentForm' : 'teacherForm').classList.remove('hidden');
        };
        const backToRoleSelection = () => {
            document.getElementById('roleSelection').classList.remove('hidden');
            ['studentForm', 'teacherForm'].forEach(id => document.getElementById(id).classList.add('hidden'));
        };
        window.backToRoleSelection = backToRoleSelection;
        document.getElementById('selectStudentRoleBtn').addEventListener('click', () => selectRole('student'));
        document.getElementById('selectTeacherRoleBtn').addEventListener('click', () => selectRole('teacher'));
        document.getElementById('backToRoleStudentBtn').addEventListener('click', backToRoleSelection);
        document.getElementById('backToRoleTeacherBtn').addEventListener('click', backToRoleSelection);
        window.showClassCode = () => { document.getElementById('displayClassCode').textContent = classCode; document.getElementById('classCodeModal').classList.remove('hidden'); }
        window.copyCode = (event) => { navigator.clipboard.writeText(currentCode).then(() => { const btn = event.target.closest('button'); if(!btn) return; const originalText = btn.innerHTML; btn.innerHTML = 'Copied!'; setTimeout(() => { btn.innerHTML = originalText; lucide.createIcons(); }, 1500); }); }
        window.closeModal = () => document.getElementById('codeModal').classList.add('hidden');
        window.closeClassCodeModal = () => document.getElementById('classCodeModal').classList.add('hidden');
        window.copyClassCode = (event) => {
            navigator.clipboard.writeText(classCode).then(() => {
                const btn = event.target.closest('button');
                if (!btn) return;
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<span>Copied!</span>';
                setTimeout(() => { btn.innerHTML = originalContent; lucide.createIcons(); }, 1500);
            });
        };
        window.openGameModal = () => { document.getElementById('gameModal').classList.remove('hidden'); startNewGame(); }
        window.closeGameModal = () => document.getElementById('gameModal').classList.add('hidden');
        window.checkSentence = checkSentence; window.startNewGame = startNewGame; window.resetCurrentSentence = resetCurrentSentence;
        
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        setInterval(() => { 
            const timeEl = document.getElementById('currentTime');
            if (timeEl) timeEl.textContent = new Date().toLocaleTimeString('en-GB'); 
        }, 1000);
        function getTimeAgo(date) { const seconds = Math.floor((new Date() - date) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + "mo ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "d ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "h ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "m ago"; return "Just now"; }
        const colors = { MENULIS: { bg: 'bg-sky-100 text-sky-800', 'soft-bg': 'bg-sky-50', text: 'text-sky-600', 'text-soft': 'text-sky-500'}, MEMBACA: { bg: 'bg-emerald-100 text-emerald-800', 'soft-bg': 'bg-emerald-50', text: 'text-emerald-600', 'text-soft': 'text-emerald-500'}, BERTUTUR: { bg: 'bg-amber-100 text-amber-800', 'soft-bg': 'bg-amber-50', text: 'text-amber-600', 'text-soft': 'text-amber-500'}, MENDENGAR: { bg: 'bg-violet-100 text-violet-800', 'soft-bg': 'bg-violet-50', text: 'text-violet-600', 'text-soft': 'text-violet-500'}};
        const statusColors = { 'Menunggu Penyerahan': { bg: 'bg-amber-100 text-amber-800' }, 'Selesai': { bg: 'bg-emerald-100 text-emerald-800' }, 'Uploading...': {bg: 'bg-sky-100 text-sky-800'}, 'Upload Failed': {bg: 'bg-red-100 text-red-800'} };
        function getSkillColor(skill, type) { return (colors[skill] && colors[skill][type]) || 'bg-slate-100 text-slate-800'; }
        function getStatusColor(status, type) { return (statusColors[status] && statusColors[status][type]) || 'bg-slate-100 text-slate-800'; }
        
        ['codeModal', 'classCodeModal', 'gameModal', 'uploadModal'].forEach(id => { document.getElementById(id).addEventListener('click', (e) => { if(e.target === e.currentTarget) e.currentTarget.classList.add('hidden'); }); });
    
        lucide.createIcons();
    </script>
</body>
</html>
" and the user is asking the following query: "I have a problem with the file size limit, it doesn't seem to work, can you add a message that tells them the file size and the max file size?"

